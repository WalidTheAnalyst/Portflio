library(tidyverse)
library(dplyr)
library(readr)
library(lubridate)
library(shiny)
library(shinydashboard)
library(leaflet)
library(shinyWidgets)
library(shinyjs)

italy_data <- read_csv("covid19_italy_region.csv")
# Convert italy_data to a data frame
italy_data <- as.data.frame(italy_data)

# Converting the date column to a Date object
italy_data$Date <- as.Date(italy_data$Date)

# Formatting the date column in the desired format (mm.dd.yyyy)
italy_data$Date <- format(italy_data$Date, format = "%m.%d.%Y")

# Calculate the total number of deaths since the beginning of the pandemic
start_date <- anydate("2020-02-24")
total_deaths <- sum(italy_data$Deaths[anydate(italy_data$Date) >= start_date])

ui <- dashboardPage(
  dashboardHeader(title = "COVID-19 Dashboard"),
  dashboardSidebar(
    dateInput("selected_date", "Select a Date:", value = max(italy_data$Date)),
    actionButton("click_button", "Select Date")
  ),
  dashboardBody(
    fluidRow(
      box(
        title = "COVID-19 Deaths by Region",
        width = 12,
        leafletOutput("italy_map")
      ),
      box(
        title = "Total COVID-19 Deaths",
        width = 4,
        textOutput("total_deaths")
      )
    )
  )
)

server <- function(input, output, session) {
  shinyjs::useShinyjs()
  
  observeEvent(input$click_button, {
    # Calculate the total number of deaths for the selected date
    selected_date <- anydate(input$selected_date)
    filtered <- italy_data %>%
      filter(anydate(Date) <= selected_date)
    
    total_deaths_selected <- sum(filtered$Deaths)
    
    # Display the total number of deaths
    output$total_deaths <- renderText({
      paste("Total Deaths Since 2020-02-24:", total_deaths_selected)
    })
  })
  
  # Create a reactive dataset filtered by date range and region
  filtered_data <- reactive({
    start_date <- anydate("2020-02-24")
    end_date <- anydate(input$selected_date)
    
    filtered <- italy_data %>%
      filter(anydate(Date) >= start_date, anydate(Date) <= end_date)
    
    return(filtered)
  })
  
  # Render the leaflet map
  output$italy_map <- renderLeaflet({
    leaflet() %>%
      addTiles() %>%
      setView(lng = 12.4964, lat = 41.9028, zoom = 6) %>%
      addCircleMarkers(
        data = filtered_data(),
        lng = ~Longitude,
        lat = ~Latitude,
        label = ~Deaths
      )
  })
}

shinyApp(ui, server)
